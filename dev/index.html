<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Home · SimpleMock.jl</title><link rel="canonical" href="https://christopher-dG.github.io/SimpleMock.jl/index.html"/><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link href="assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>SimpleMock.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li class="current"><a class="toctext" href>Home</a><ul class="internal"><li><a class="toctext" href="#The-Mock-object-1">The <code>Mock</code> object</a></li><li><a class="toctext" href="#The-mock-Function-1">The <code>mock</code> Function</a></li><li><a class="toctext" href="#Filter-Functions-1">Filter Functions</a></li></ul></li></ul></nav><article id="docs"><header><nav><ul><li><a href>Home</a></li></ul><a class="edit-page" href="https://github.com/christopher-dG/SimpleMock.jl/blob/master/docs/src/index.md#L"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>Home</span><a class="fa fa-bars" href="#"></a></div></header><h1><a class="nav-anchor" id="SimpleMock-1" href="#SimpleMock-1">SimpleMock</a></h1><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.SimpleMock" href="#SimpleMock.SimpleMock"><code>SimpleMock.SimpleMock</code></a> — <span class="docstring-category">Module</span>.</div><div><div><p>A basic mocking module, inspired by Python&#39;s <a href="https://docs.python.org/3/library/unittest.mock.html"><code>unittest.mock</code></a> and implemented with <a href="https://github.com/jrevels/Cassette.jl">Cassette</a>.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/SimpleMock.jl#LL1-L3">source</a></section><h2><a class="nav-anchor" id="The-Mock-object-1" href="#The-Mock-object-1">The <code>Mock</code> object</a></h2><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.Mock" href="#SimpleMock.Mock"><code>SimpleMock.Mock</code></a> — <span class="docstring-category">Type</span>.</div><div><div><pre><code class="language-julia">Mock(; return_value=Mock(), side_effect=nothing)</code></pre><p>Create a new mocking object that can act as a replacement for a function.</p><p><strong>Return Value</strong></p><p>Use the <code>return_value</code> keyword to set the value to be returned upon calling the mock. By default, the return value is a new <code>Mock</code>.</p><p><strong>Side Effects</strong></p><p>Use the <code>side_effect</code> keyword to set a side effect to occur upon calling the mock.</p><ul><li>If the value is an <code>Exception</code>, then the exception is thrown.</li><li>If the value is a function, then it is called with the same arguments and keywords.</li><li>If the value is a <code>Vector</code>, then each call uses the next element.</li><li>Any other value except <code>nothing</code> is returned without modification.</li></ul></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/mock_type.jl#LL17-L34">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.calls" href="#SimpleMock.calls"><code>SimpleMock.calls</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">calls(::Mock) -&gt; Vector{Call}</code></pre><p>Return the call history of the <a href="#SimpleMock.Mock"><code>Mock</code></a>.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/mock_type.jl#LL68-L72">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.ncalls" href="#SimpleMock.ncalls"><code>SimpleMock.ncalls</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">ncalls(::Mock) -&gt; Int</code></pre><p>Return the number of times that the <a href="#SimpleMock.Mock"><code>Mock</code></a> has been called.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/mock_type.jl#LL75-L79">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.called" href="#SimpleMock.called"><code>SimpleMock.called</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">called(::Mock) -&gt; Bool</code></pre><p>Return whether or not the <a href="#SimpleMock.Mock"><code>Mock</code></a> has been called.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/mock_type.jl#LL82-L86">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.called_once" href="#SimpleMock.called_once"><code>SimpleMock.called_once</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">called_once(::Mock) -&gt; Bool</code></pre><p>Return whether or not the <a href="#SimpleMock.Mock"><code>Mock</code></a> has been called exactly once.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/mock_type.jl#LL89-L93">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.called_with" href="#SimpleMock.called_with"><code>SimpleMock.called_with</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">called_with(::Mock, args...; kwargs...) -&gt; Bool</code></pre><p>Return whether or not the <a href="#SimpleMock.Mock"><code>Mock</code></a> has been called with the given arguments.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/mock_type.jl#LL96-L100">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.called_once_with" href="#SimpleMock.called_once_with"><code>SimpleMock.called_once_with</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">called_once_with(::Mock, args...; kwargs...) -&gt; Bool</code></pre><p>Return whether or not the <a href="#SimpleMock.Mock"><code>Mock</code></a> has been called exactly once with the given arguments.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/mock_type.jl#LL103-L107">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.Call" href="#SimpleMock.Call"><code>SimpleMock.Call</code></a> — <span class="docstring-category">Type</span>.</div><div><div><pre><code class="language-julia">Call(args...; kwargs...)</code></pre><p>Represents a function call.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/mock_type.jl#LL3-L7">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.has_call" href="#SimpleMock.has_call"><code>SimpleMock.has_call</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">has_call(::Mock, ::Call) -&gt; Bool</code></pre><p>Similiar to <a href="#SimpleMock.called_with"><code>called_with</code></a>, but using a <a href="#SimpleMock.Call"><code>Call</code></a>.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/mock_type.jl#LL111-L115">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.has_calls" href="#SimpleMock.has_calls"><code>SimpleMock.has_calls</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">has_calls(::Mock, ::Calls...) -&gt; Bool</code></pre><p>Return whether or not the <a href="#SimpleMock.Mock"><code>Mock</code></a> has a particular ordered sequence of <a href="#SimpleMock.Call"><code>Call</code></a>s.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/mock_type.jl#LL118-L122">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.reset!" href="#SimpleMock.reset!"><code>SimpleMock.reset!</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">reset!(::Mock)</code></pre><p>Reset a <a href="#SimpleMock.Mock"><code>Mock</code></a>&#39;s call history. Side effects and return values are preserved.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/mock_type.jl#LL135-L140">source</a></section><h2><a class="nav-anchor" id="The-mock-Function-1" href="#The-mock-Function-1">The <code>mock</code> Function</a></h2><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.mock" href="#SimpleMock.mock"><code>SimpleMock.mock</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">mock(f::Function[, ctx::Symbol], args...; filters::Vector{&lt;:Function}=Function[])</code></pre><p>Run <code>f</code> with specified functions mocked out.</p><p><strong>Examples</strong></p><p>Mocking a single function:</p><pre><code class="language-julia">mock(print) do p
    @assert p isa Mock
    println(&quot;!&quot;)  # This won&#39;t output anything.
    @assert called_once_with(p, stdout, &quot;!&quot;, &#39;\n&#39;)
end</code></pre><p>Mocking a function with a custom <a href="#SimpleMock.Mock"><code>Mock</code></a>:</p><pre><code class="language-julia">mock((+) =&gt; Mock(; return_value=1)) do plus
    @assert 1 + 1 == 1
    @assert called_once_with(plus, 1, 1)
end</code></pre><p>Mocking methods that match a given signature:</p><pre><code class="language-julia">mock((+, Float64, Float64) =&gt; Mock(; side_effect=(a, b) -&gt; 2a + 2b)) do plus
    @assert 1 + 1 == 2
    @assert 2.0 + 2.0 == 8
    @assert called_once_with(plus, 2.0, 2.0)
end</code></pre><p>Mocking with something other than a <code>Mock</code>:</p><pre><code class="language-julia">mock((+) =&gt; (a, b) -&gt; 2a + 2b) do _plus
    @assert 1 + 2 == 6
end</code></pre><p><strong>Using Filters</strong></p><p>Oftentimes, you mock a function with a very specific idea of where you want that mocking to happen. It can be confusing when a call you didn&#39;t anticipate gets mocked somewhere deep in the call stack, botching everything. To avoid this, you can use filter functions, like so:</p><pre><code class="language-julia">f(x) = print(x)
g(x) = f(x)
mock(print; filters=[max_depth(2)]) do p
    f(&quot;this won&#39;t print&quot;)  # The call depth of print here is 2.
    g(&quot;this will print&quot;)   # Here, it&#39;s 3.
    @assert called_once_with(p, &quot;this won&#39;t print&quot;)
end</code></pre><p>Filter functions take a single argument of type <a href="#SimpleMock.Metadata"><code>Metadata</code></a>. See <a href="#Filter-Functions-1">Filter Functions</a> for a list of included filters, as well as building blocks for you to create your own.</p><p><strong>Performance Tips</strong></p><p><strong>Avoid Printing</strong></p><p>Printing is, for whatever reason, glacially slow inside of mock blocks. To illustrate:</p><pre><code class="language-julia">julia&gt; @time mock(println, log)
Mock{Symbol,Nothing}(Symbol(&quot;##390&quot;), Call[], Symbol(&quot;##371&quot;), nothing)
  7.389156 seconds (19.52 M allocations: 1.029 GiB, 7.71% gc time)

julia&gt; @time println(mock(identity, log))
Mock{Symbol,Nothing}(Symbol(&quot;##394&quot;), Call[], Symbol(&quot;##371&quot;), nothing)
  0.136950 seconds (120.96 k allocations: 6.507 MiB</code></pre><p>Unfortunately, this includes the display of failed <code>@test</code>s, so it&#39;s wise to avoid making assertions in the mocked environment.</p><pre><code class="language-julia">#= bad:  =# mock(lg -&gt; @test(!called(lg), log)
#= good: =# @test !called(mock(identity, log))</code></pre><p>The second strategy is orders of magnitude faster than the first when the test fails, and it&#39;s also faster when the test passes.</p><p><strong>Don&#39;t Filter Unless Necessary</strong></p><p>Filtering introduces significant bookkeeping overhead. Avoid it whenever possible!</p><p><strong>Reuse Your <code>Context</code>s</strong></p><p>Under the hood, this function creates a new <a href="https://jrevels.github.io/Cassette.jl/stable/api.html#Cassette.Context">Cassette <code>Context</code></a> on every call by default. This provides a nice clean mocking environment, but it can be slow to create and call new types and methods over and over. If you find yourself repeatedly mocking the same set of functions, you can specify a context name to reuse that context like so:</p><pre><code class="language-julia">julia&gt; ctx = gensym();

# The first time takes a little while.
julia&gt; @time mock(g -&gt; @assert(!called(g)), ctx, get)
  0.156221 seconds (171.93 k allocations: 9.356 MiB)

# But the next time is faster!
julia&gt; @time mock(g -&gt; @assert(!called(g)), ctx, get)
  0.052324 seconds (27.38 k allocations: 1.437 MiB)</code></pre><p>Be careful though! If you call a function that you&#39;ve previously mocked but are not currently mocking, you&#39;ll run into trouble:</p><pre><code class="language-julia">julia&gt; f(s) = strip(uppercase(s));
julia&gt; ctx = gensym();

julia&gt; mock(_g -&gt; f(&quot; hi &quot;), ctx, strip =&gt; s -&gt; &quot;hi&quot;);
julia&gt; mock(_g -&gt; f(&quot; hi &quot;), ctx, uppercase =&gt; s -&gt; &quot; HI &quot;)
ERROR: KeyError: key (strip, Vararg{Any,N} where N) not found</code></pre></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/mock_fun.jl#LL3-L126">source</a></section><h2><a class="nav-anchor" id="Filter-Functions-1" href="#Filter-Functions-1">Filter Functions</a></h2><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.max_depth" href="#SimpleMock.max_depth"><code>SimpleMock.max_depth</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">min_depth(n::Int) -&gt; Function</code></pre><p>Create a filter that rejects when the current call depth is greater than <code>n</code>.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/filters.jl#LL1-L5">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.min_depth" href="#SimpleMock.min_depth"><code>SimpleMock.min_depth</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">min_depth(n::Int) -&gt; Function</code></pre><p>Create a filter that rejects when the current call depth is less than <code>n</code>.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/filters.jl#LL8-L12">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.excluding" href="#SimpleMock.excluding"><code>SimpleMock.excluding</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">excluding(args...) -&gt; Function</code></pre><p>Create a filter that rejects when the calling function or module is in <code>args</code>.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/filters.jl#LL15-L19">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.including" href="#SimpleMock.including"><code>SimpleMock.including</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">including(args...) -&gt; Function</code></pre><p>Create a filter that rejects when the calling function or module is not in <code>args</code>.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/filters.jl#LL22-L26">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.Metadata" href="#SimpleMock.Metadata"><code>SimpleMock.Metadata</code></a> — <span class="docstring-category">Type</span>.</div><div><div><p>Container for mocks and bookkeeping data. Instances of this type are aware of the call depth (<a href="#SimpleMock.current_depth"><code>current_depth</code></a>) and the current function/module (<a href="#SimpleMock.current_function"><code>current_function</code></a>/<a href="#SimpleMock.current_module"><code>current_module</code></a>).</p><p>All filter functions take a single argument of this type.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/metadata.jl#LL1-L6">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.current_depth" href="#SimpleMock.current_depth"><code>SimpleMock.current_depth</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">current_depth(::Metadata) -&gt; Int</code></pre><p>Return the current call depth (the size of the call stack). The depth is always positive, so the first function entered has a depth of 1.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/metadata.jl#LL16-L21">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.current_function" href="#SimpleMock.current_function"><code>SimpleMock.current_function</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">current_function(::Metadata) -&gt; Any</code></pre><p>Return the current function (or other callable thing). In this case, &quot;current&quot; refers, somewhat counterintuitively, not to the function about to be called, but to the function that is about to call it.</p><p>To illustrate:</p><pre><code class="language-julia">f(x) = x
g(x) = f(x)
x = g(1)</code></pre><p>In this case, when the call to <code>f</code> is reached, the function that is calling <code>f</code> is <code>g</code>. Therefore, the &quot;current&quot; function is <code>g</code>.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/metadata.jl#LL24-L40">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="SimpleMock.current_module" href="#SimpleMock.current_module"><code>SimpleMock.current_module</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">current_module(m::Metadata) -&gt; Module</code></pre><p>Return the current module, where &quot;current&quot; has the same definition as in <a href="#SimpleMock.current_function"><code>current_function</code></a>.</p></div></div><a class="source-link" target="_blank" href="https://github.com/christopher-dG/SimpleMock.jl/blob/db925097405c3943f129e9a44ee26dffa6f89b78/src/metadata.jl#LL43-L47">source</a></section><ul><li><a href="#SimpleMock.SimpleMock"><code>SimpleMock.SimpleMock</code></a></li><li><a href="#SimpleMock.Call"><code>SimpleMock.Call</code></a></li><li><a href="#SimpleMock.Metadata"><code>SimpleMock.Metadata</code></a></li><li><a href="#SimpleMock.Mock"><code>SimpleMock.Mock</code></a></li><li><a href="#SimpleMock.called"><code>SimpleMock.called</code></a></li><li><a href="#SimpleMock.called_once"><code>SimpleMock.called_once</code></a></li><li><a href="#SimpleMock.called_once_with"><code>SimpleMock.called_once_with</code></a></li><li><a href="#SimpleMock.called_with"><code>SimpleMock.called_with</code></a></li><li><a href="#SimpleMock.calls"><code>SimpleMock.calls</code></a></li><li><a href="#SimpleMock.current_depth"><code>SimpleMock.current_depth</code></a></li><li><a href="#SimpleMock.current_function"><code>SimpleMock.current_function</code></a></li><li><a href="#SimpleMock.current_module"><code>SimpleMock.current_module</code></a></li><li><a href="#SimpleMock.excluding"><code>SimpleMock.excluding</code></a></li><li><a href="#SimpleMock.has_call"><code>SimpleMock.has_call</code></a></li><li><a href="#SimpleMock.has_calls"><code>SimpleMock.has_calls</code></a></li><li><a href="#SimpleMock.including"><code>SimpleMock.including</code></a></li><li><a href="#SimpleMock.max_depth"><code>SimpleMock.max_depth</code></a></li><li><a href="#SimpleMock.min_depth"><code>SimpleMock.min_depth</code></a></li><li><a href="#SimpleMock.mock"><code>SimpleMock.mock</code></a></li><li><a href="#SimpleMock.ncalls"><code>SimpleMock.ncalls</code></a></li><li><a href="#SimpleMock.reset!"><code>SimpleMock.reset!</code></a></li></ul><footer><hr/></footer></article></body></html>
